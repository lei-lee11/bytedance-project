import { Renderer } from '../render/renderer.js';
import { getRandomPosition } from '../utils/position.js';

export class Game {
    constructor(canvas) {
        // 基础配置
        this.canvas = canvas;
        this.ctx = canvas.getContext('2d');
        this.cellSize = 20;
        this.gridSize = 20;
        this.canvas.width = this.gridSize * this.cellSize;
        this.canvas.height = this.gridSize * this.cellSize;

        // 游戏状态
        this.score = 0;
        this.gameOver = false;
        this.direction = { x: 1, y: 0 };
        this.snake = [{ x: 5, y: 5 }];

        // 元素引用
        this.scoreElement = document.getElementById('score');
        this.gameOverElement = document.getElementById('gameOver');
        this.finalScoreElement = document.getElementById('finalScore');
        this.restartBtn = document.getElementById('restartBtn');

        // 模块初始化
        this.renderer = new Renderer(this.ctx, this.cellSize);
        this.food = this.generateFood();

        // 事件绑定
        this.restartBtn.addEventListener('click', () => this.restart());

        // 启动游戏循环
        this.startGameLoop();
    }

    // 生成食物
    generateFood() {
        let position;
        do {
            position = getRandomPosition(this.gridSize);
        } while (this.checkCollision(position, this.snake));
        return position;
    }

    // 碰撞检测（通用）
    checkCollision(target, entities) {
        return entities.some(entity => entity.x === target.x && entity.y === target.y);
    }

    // 更新游戏状态
    update() {
        if (this.gameOver) return;

        // 移动蛇头
        const head = { ...this.snake[0] };
        head.x += this.direction.x;
        head.y += this.direction.y;
        this.snake.unshift(head);

        // 食物碰撞处理
        if (this.checkCollision(head, [this.food])) {
            this.score++;
            this.scoreElement.textContent = this.score;
            this.food = this.generateFood();
        } else {
            this.snake.pop();
        }

        // 边界与自撞检测
        this.checkGameOver();
    }

    // 游戏结束判定
    checkGameOver() {
        const head = this.snake[0];
        // 边界碰撞
        if (head.x < 0 || head.x >= this.gridSize || head.y < 0 || head.y >= this.gridSize) {
            this.triggerGameOver();
        }
        // 自撞
        if (this.checkCollision(head, this.snake.slice(1))) {
            this.triggerGameOver();
        }
    }

    // 触发游戏结束
    triggerGameOver() {
        this.gameOver = true;
        this.gameOverElement.style.display = 'block';
        this.finalScoreElement.textContent = this.score;
        clearInterval(this.gameLoopInterval);
    }

    // 重新开始游戏
    restart() {
        this.gameOver = false;
        this.score = 0;
        this.direction = { x: 1, y: 0 };
        this.snake = [{ x: 5, y: 5 }];
        this.food = this.generateFood();
        this.scoreElement.textContent = this.score;
        this.gameOverElement.style.display = 'none';
        this.startGameLoop();
    }

    // 启动游戏循环
    startGameLoop() {
        this.gameLoopInterval = setInterval(() => {
            this.update();
            this.render();
        }, 120);
    }

    // 渲染游戏
    render() {
        this.renderer.clearCanvas(this.canvas.width, this.canvas.height);
        this.renderer.drawSnake(this.snake);
        this.renderer.drawFood(this.food);
    }
}